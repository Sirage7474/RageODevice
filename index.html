<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>RageODevice Configurator</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&display=swap" rel="stylesheet">
<style>
* { margin:0; padding:0; box-sizing:border-box; }

body {
  background:#000;
  color:#fff;
  font-family:'Orbitron',sans-serif;
  text-align:center;
  min-height:100vh;
  padding:20px;
  overflow-x:hidden;
}

.page { display:none; }
.page.active { display:block; }

h1 {
  margin:30px 0 8px;
  font-size:38px;
  font-weight:900;
  color:#fff;
  letter-spacing:3px;
}

.subtitle {
  color:#555;
  font-size:11px;
  margin-bottom:30px;
  letter-spacing:3px;
}

/* CONNECTION PAGE */
.connection-wrap {
  display:flex;
  align-items:center;
  justify-content:center;
  min-height:70vh;
}

.connection-box {
  background:#0a0a0a;
  border:2px solid #fff;
  border-radius:20px;
  padding:50px 70px;
  max-width:580px;
  width:100%;
  position:relative;
  overflow:hidden;
}

.connection-box::before {
  content:'';
  position:absolute;
  top:-50%; left:-50%;
  width:200%; height:200%;
  background:conic-gradient(transparent, transparent, transparent, #fff);
  animation:rotate 4s linear infinite;
  opacity:0.03;
  pointer-events:none;
}

@keyframes rotate { 100% { transform:rotate(360deg); } }

.connection-box h2 {
  font-size:20px;
  margin-bottom:10px;
  letter-spacing:2px;
}

.connection-box > p {
  color:#555;
  font-size:11px;
  margin-bottom:25px;
  line-height:1.8;
  letter-spacing:1px;
}

.device-info {
  background:#000;
  border:1px solid #1a1a1a;
  border-radius:10px;
  padding:16px 20px;
  margin:20px 0;
  text-align:left;
  font-size:11px;
  line-height:2.2;
}

.device-info strong { color:#fff; display:block; margin-bottom:2px; }
.device-info span { color:#555; }

.scan-wrap { margin:20px 0; }

.scan-circle {
  width:90px; height:90px;
  border:2px solid #1a1a1a;
  border-top:2px solid #fff;
  border-radius:50%;
  margin:0 auto 18px;
  animation:spin 1s linear infinite;
  display:none;
}

.scan-circle.active { display:block; }
@keyframes spin { 100% { transform:rotate(360deg); } }

.scan-dots { display:none; justify-content:center; gap:8px; margin-bottom:12px; }
.scan-dots.active { display:flex; }

.dot {
  width:7px; height:7px; background:#fff;
  border-radius:50%;
  animation:dotPulse 1.2s ease-in-out infinite;
}
.dot:nth-child(2) { animation-delay:0.2s; }
.dot:nth-child(3) { animation-delay:0.4s; }

@keyframes dotPulse {
  0%,100% { opacity:0.15; transform:scale(0.8); }
  50% { opacity:1; transform:scale(1.2); }
}

.scan-text { font-size:10px; color:#555; letter-spacing:2px; min-height:18px; }

.connect-btn {
  background:#fff; color:#000; border:none;
  padding:15px 45px; border-radius:30px;
  font-weight:900; cursor:pointer;
  font-family:'Orbitron',sans-serif;
  font-size:13px; letter-spacing:2px;
  transition:all 0.3s; margin-top:8px;
}

.connect-btn:hover { background:#ddd; transform:translateY(-2px); box-shadow:0 8px 25px rgba(255,255,255,0.15); }
.connect-btn:active { transform:translateY(0); }
.connect-btn:disabled { background:#1a1a1a; color:#444; cursor:not-allowed; transform:none; box-shadow:none; }

#connectionStatus { margin-top:14px; color:#555; font-size:10px; letter-spacing:1px; min-height:18px; }

/* PORT PICKER */
.port-overlay {
  display:none;
  position:fixed;
  top:0; left:0; right:0; bottom:0;
  background:rgba(0,0,0,0.85);
  z-index:1000;
  align-items:center;
  justify-content:center;
  backdrop-filter:blur(4px);
}

.port-overlay.active { display:flex; }

.port-dialog {
  background:#0a0a0a;
  border:2px solid #fff;
  border-radius:20px;
  padding:40px;
  width:500px;
  max-width:95vw;
  position:relative;
  animation:dialogIn 0.3s cubic-bezier(0.34,1.56,0.64,1);
}

@keyframes dialogIn {
  from { transform:scale(0.8); opacity:0; }
  to { transform:scale(1); opacity:1; }
}

.port-dialog h3 { font-size:16px; letter-spacing:2px; margin-bottom:6px; }

.port-dialog p {
  color:#555; font-size:10px; letter-spacing:1px;
  margin-bottom:25px; line-height:1.7;
}

.port-list {
  display:flex; flex-direction:column; gap:8px;
  max-height:280px; overflow-y:auto; margin-bottom:20px;
}

.port-list::-webkit-scrollbar { width:4px; }
.port-list::-webkit-scrollbar-track { background:#000; }
.port-list::-webkit-scrollbar-thumb { background:#333; border-radius:2px; }

.port-item {
  display:flex; align-items:center; justify-content:space-between;
  background:#000; border:1px solid #1a1a1a;
  border-radius:10px; padding:14px 18px;
  cursor:pointer; transition:all 0.2s; text-align:left;
}

.port-item:hover { border-color:#fff; background:#0d0d0d; }
.port-item.selected { border-color:#fff; background:#111; }

.port-item-left { flex:1; }
.port-item-name { font-size:13px; font-weight:700; color:#fff; letter-spacing:1px; margin-bottom:4px; }
.port-item-detail { font-size:9px; color:#444; letter-spacing:1px; }

.port-item-badge {
  background:#fff; color:#000; font-size:9px;
  font-weight:900; letter-spacing:1px; padding:4px 10px; border-radius:20px;
}

.port-item-badge.unknown { background:#1a1a1a; color:#555; }

.port-empty { text-align:center; padding:30px 20px; }
.port-empty p { color:#444; font-size:10px; letter-spacing:1px; margin-bottom:8px; }

.port-scanning { display:none; text-align:center; padding:20px; }
.port-scanning.active { display:block; }

.port-scan-ring {
  width:50px; height:50px;
  border:2px solid #1a1a1a; border-top:2px solid #fff;
  border-radius:50%; margin:0 auto 14px;
  animation:spin 0.8s linear infinite;
}

.port-scanning p { color:#555; font-size:10px; letter-spacing:2px; }

.port-dialog-btns { display:flex; gap:10px; justify-content:flex-end; }

.port-btn-cancel {
  background:transparent; color:#555; border:1px solid #222;
  padding:12px 24px; border-radius:10px;
  font-family:'Orbitron',sans-serif; font-size:11px; letter-spacing:1px;
  cursor:pointer; transition:all 0.2s;
}

.port-btn-cancel:hover { color:#fff; border-color:#555; }

.port-btn-connect {
  background:#fff; color:#000; border:none;
  padding:12px 28px; border-radius:10px;
  font-family:'Orbitron',sans-serif; font-size:11px;
  font-weight:900; letter-spacing:1px;
  cursor:pointer; transition:all 0.2s;
}

.port-btn-connect:hover { background:#ddd; }
.port-btn-connect:disabled { background:#1a1a1a; color:#444; cursor:not-allowed; }

.port-btn-refresh {
  background:transparent; color:#555; border:1px solid #222;
  padding:12px 20px; border-radius:10px;
  font-family:'Orbitron',sans-serif; font-size:11px; letter-spacing:1px;
  cursor:pointer; transition:all 0.2s; margin-right:auto;
}

.port-btn-refresh:hover { color:#fff; border-color:#555; }

/* STATUS */
.status {
  border:1px solid #fff; padding:10px 22px;
  border-radius:25px; display:inline-block;
  margin-bottom:25px; font-size:11px; color:#fff; letter-spacing:2px;
}

.status.success { animation:statusFlash 0.5s ease; }

@keyframes statusFlash {
  0% { background:#fff; color:#000; }
  100% { background:transparent; color:#fff; }
}

/* BOARD */
.board {
  width:600px; max-width:95vw; height:400px;
  margin:25px auto; border:3px solid #fff;
  border-radius:20px; position:relative; background:#0a0a0a;
}

.oled {
  position:absolute; top:40px; left:49%;
  transform:translateX(-50%); width:210px; height:110px;
  border:3px solid #fff; border-radius:8px;
  display:flex; align-items:center; justify-content:center;
  font-size:16px; font-weight:700; background:#000; color:#fff; letter-spacing:2px;
}

.encoderWrap { position:absolute; left:42.5px; top:50px; text-align:center; }

.encoder {
  width:90px; height:90px; border:3px solid #fff;
  border-radius:50%; display:flex; align-items:center;
  justify-content:center; margin:0 auto 10px; background:#0a0a0a;
  font-weight:700; font-size:13px; color:#fff;
  cursor:pointer; transition:all 0.3s;
}

.encoder:hover { background:#111; transform:rotate(20deg); }

.buttons {
  position:absolute; bottom:45px; left:50%;
  transform:translateX(-50%); display:flex; gap:20px;
}

.btnBox { text-align:center; transition:all 0.3s; }
.btnBox:hover { transform:translateY(-5px); }

.btn {
  width:110px; height:110px; border:3px solid #fff;
  border-radius:16px; display:flex; align-items:center;
  justify-content:center; margin-bottom:10px; font-size:24px;
  font-weight:900; background:#0a0a0a; color:#fff;
  cursor:pointer; transition:all 0.3s; position:relative; overflow:hidden;
}

.btn::after {
  content:''; position:absolute; top:50%; left:50%;
  width:0; height:0; background:rgba(255,255,255,0.08);
  border-radius:50%; transform:translate(-50%,-50%); transition:all 0.4s;
}

.btn:hover { background:#111; }
.btn:hover::after { width:160px; height:160px; }
.btn:active { transform:scale(0.95); }

select {
  background:#000; color:#fff; border:2px solid #fff;
  padding:8px 6px; font-family:'Orbitron',sans-serif;
  width:115px; border-radius:8px; font-size:11px;
  font-weight:500; cursor:pointer; transition:all 0.2s;
}

select:hover { background:#111; }
select:focus { outline:none; background:#111; }
option { background:#0a0a0a; }
.encoder-select { width:100px; font-size:10px; }

/* CONTROLS */
.controls { margin-top:35px; display:flex; justify-content:center; gap:15px; flex-wrap:wrap; }

.flash-btn {
  background:#fff; color:#000; border:none;
  padding:15px 45px; border-radius:30px; font-weight:900;
  cursor:pointer; font-family:'Orbitron',sans-serif;
  font-size:13px; letter-spacing:2px; transition:all 0.3s;
  position:relative; overflow:hidden;
}

.flash-btn::before {
  content:''; position:absolute; top:0; left:-100%;
  width:100%; height:100%;
  background:linear-gradient(90deg, transparent, rgba(255,255,255,0.35), transparent);
  transition:left 0.5s;
}

.flash-btn:hover::before { left:100%; }
.flash-btn:hover { background:#ddd; transform:translateY(-2px); }
.flash-btn:active { transform:translateY(0); }
.flash-btn:disabled { background:#1a1a1a; color:#444; cursor:not-allowed; }

.flash-progress { display:none; margin:20px auto; max-width:500px; }
.flash-progress.active { display:block; }

.progress-bar-wrap {
  background:#0a0a0a; border:1px solid #1a1a1a;
  border-radius:30px; height:4px; overflow:hidden; margin-bottom:10px;
}

.progress-bar-fill {
  height:100%; background:#fff; border-radius:30px; width:0%; transition:width 0.3s ease;
}

.progress-text { font-size:10px; color:#555; letter-spacing:2px; }

.disconnect-btn {
  background:transparent; color:#444; border:1px solid #222;
  padding:15px 35px; border-radius:30px; font-weight:700;
  cursor:pointer; font-family:'Orbitron',sans-serif;
  font-size:12px; letter-spacing:1px; transition:all 0.3s;
}

.disconnect-btn:hover { color:#fff; border-color:#fff; transform:translateY(-2px); }

/* PRESET SYSTEM */
.preset-section {
  margin:30px auto; max-width:700px;
  background:#0a0a0a; border:1px solid #1a1a1a;
  border-radius:15px; padding:25px 30px; text-align:left;
}

.preset-section h3 {
  color:#fff; font-size:13px; letter-spacing:2px;
  margin-bottom:20px; padding-bottom:12px; border-bottom:1px solid #111;
}

.preset-row { display:flex; align-items:center; gap:10px; margin-bottom:14px; flex-wrap:wrap; }

.preset-label { font-size:10px; color:#444; letter-spacing:1px; min-width:70px; }

.preset-name-input {
  background:#000; color:#fff; border:1px solid #222;
  padding:10px 14px; border-radius:8px;
  font-family:'Orbitron',sans-serif; font-size:11px;
  letter-spacing:1px; flex:1; min-width:140px; transition:border-color 0.2s;
}

.preset-name-input:focus { outline:none; border-color:#fff; }
.preset-name-input::placeholder { color:#2a2a2a; }

.preset-btn {
  background:transparent; color:#aaa; border:1px solid #222;
  padding:10px 18px; border-radius:8px;
  font-family:'Orbitron',sans-serif; font-size:10px;
  letter-spacing:1px; cursor:pointer; transition:all 0.2s; white-space:nowrap;
}

.preset-btn:hover { color:#fff; border-color:#fff; transform:translateY(-1px); }
.preset-btn.primary { background:#fff; color:#000; border-color:#fff; }
.preset-btn.primary:hover { background:#ddd; }

.file-import-wrap { position:relative; display:inline-block; }
#fileInput { position:absolute; top:0; left:0; width:100%; height:100%; opacity:0; cursor:pointer; }

.preset-list { margin-top:16px; display:flex; flex-direction:column; gap:8px; }

.preset-empty { font-size:10px; color:#2a2a2a; letter-spacing:1px; padding:15px 0; text-align:center; }

.preset-item {
  display:flex; align-items:center; justify-content:space-between;
  background:#000; border:1px solid #111;
  border-radius:8px; padding:12px 16px; transition:border-color 0.2s;
}

.preset-item:hover { border-color:#333; }
.preset-item-name { font-size:11px; color:#fff; letter-spacing:1px; flex:1; }
.preset-item-date { font-size:9px; color:#2a2a2a; letter-spacing:1px; margin:0 14px; }
.preset-item-actions { display:flex; gap:7px; }

.preset-action-btn {
  background:transparent; color:#444; border:1px solid #1a1a1a;
  padding:6px 11px; border-radius:6px;
  font-family:'Orbitron',sans-serif; font-size:9px;
  letter-spacing:1px; cursor:pointer; transition:all 0.2s;
}

.preset-action-btn.load:hover { color:#fff; border-color:#fff; background:#111; }
.preset-action-btn.dl:hover { color:#fff; border-color:#fff; background:#111; }
.preset-action-btn.del:hover { color:#fff; border-color:#fff; background:#1a0000; }

/* HOW TO */
.howto {
  margin:20px auto; max-width:700px;
  background:#0a0a0a; border:1px solid #111;
  border-radius:15px; padding:25px 30px;
  text-align:left; font-size:11px; line-height:2;
}

.howto h3 { color:#fff; margin-bottom:12px; font-size:13px; letter-spacing:2px; }
.howto ol { margin-left:20px; color:#444; }
.howto li { margin:6px 0; }

/* TOAST */
.toast {
  position:fixed; bottom:30px; left:50%;
  transform:translateX(-50%) translateY(100px);
  background:#fff; color:#000;
  padding:14px 30px; border-radius:30px;
  font-size:12px; font-weight:700; letter-spacing:2px;
  transition:transform 0.4s cubic-bezier(0.34,1.56,0.64,1);
  z-index:9999; white-space:nowrap;
}

.toast.show { transform:translateX(-50%) translateY(0); }
</style>
</head>
<body>

<div class="toast" id="toast"></div>

<!-- CUSTOM PORT PICKER -->
<div class="port-overlay" id="portOverlay">
  <div class="port-dialog">
    <h3>Select Device</h3>
    <p>Choose your RageODevice from the list below.<br>Make sure it is connected via USB.</p>

    <div class="port-scanning" id="portScanning">
      <div class="port-scan-ring"></div>
      <p>Scanning for devices...</p>
    </div>

    <div class="port-list" id="portList"></div>

    <div class="port-dialog-btns">
      <button class="port-btn-refresh" onclick="refreshPorts()">Refresh</button>
      <button class="port-btn-cancel" onclick="closePortDialog()">Cancel</button>
      <button class="port-btn-connect" id="portConnectBtn" onclick="connectSelected()" disabled>Connect</button>
    </div>
  </div>
</div>

<!-- PAGE 1: CONNECT -->
<div id="page1" class="page active">
  <h1>RageODevice</h1>
  <p class="subtitle">CUSTOM KEYBOARD CONFIGURATOR</p>

  <div class="connection-wrap">
    <div class="connection-box">
      <h2>Connect to RageODevice</h2>
      <p>Connect your device via USB and click the button below.<br>
      <span style="color:#555;font-size:10px;letter-spacing:1px;">Use Chrome or Edge for Web Serial support</span></p>

      <div class="device-info">
        <strong>Device name:</strong>
        <span>RageODevice</span>
        <strong>Baud rate:</strong>
        <span>115200</span>
        <strong>Connection:</strong>
        <span>USB</span>
      </div>

      <div class="scan-wrap">
        <div class="scan-circle" id="scanCircle"></div>
        <div class="scan-dots" id="scanDots">
          <div class="dot"></div>
          <div class="dot"></div>
          <div class="dot"></div>
        </div>
        <div class="scan-text" id="scanText"></div>
      </div>

      <button class="connect-btn" onclick="openPortDialog()" id="connectBtn">Connect Device</button>
      <p id="connectionStatus"></p>
    </div>
  </div>
</div>

<!-- PAGE 2: CONFIGURATOR -->
<div id="page2" class="page">
  <h1>RageODevice</h1>
  <p class="subtitle">CUSTOM KEYBOARD CONFIGURATOR</p>

  <div class="status" id="status">Connected</div>

  <div class="board">
    <div class="oled">RageODevice</div>

    <div class="encoderWrap">
      <div class="encoder" id="encoderDisplay">VOL</div>
      <select id="enc" class="encoder-select" onchange="updateEncoderDisplay()">
        <option value="0">Volume</option>
        <option value="1">Zoom</option>
        <option value="2">Scroll</option>
      </select>
    </div>

    <div class="buttons">
      <div class="btnBox"><div class="btn">S1</div><select id="b1"></select></div>
      <div class="btnBox"><div class="btn">S2</div><select id="b2"></select></div>
      <div class="btnBox"><div class="btn">S3</div><select id="b3"></select></div>
      <div class="btnBox"><div class="btn">S4</div><select id="b4"></select></div>
    </div>
  </div>

  <div class="flash-progress" id="flashProgress">
    <div class="progress-bar-wrap">
      <div class="progress-bar-fill" id="progressFill"></div>
    </div>
    <div class="progress-text" id="progressText">Sending...</div>
  </div>

  <div class="controls">
    <button class="flash-btn" onclick="sendToDevice()" id="sendBtn">Send to Device</button>
    <button class="disconnect-btn" onclick="disconnectDevice()">Disconnect</button>
  </div>

  <!-- PRESET SYSTEM -->
  <div class="preset-section">
    <h3>Presets</h3>

    <div class="preset-row">
      <span class="preset-label">Save as:</span>
      <input type="text" class="preset-name-input" id="presetNameInput" placeholder="Preset name...">
      <button class="preset-btn primary" onclick="savePreset()">Save</button>
      <button class="preset-btn" onclick="downloadPreset()">Download .txt</button>
    </div>

    <div class="preset-row">
      <span class="preset-label">Import:</span>
      <div class="file-import-wrap">
        <button class="preset-btn">Import .txt</button>
        <input type="file" id="fileInput" accept=".txt" onchange="importPreset(event)">
      </div>
    </div>

    <div class="preset-list" id="presetList"></div>
  </div>

  <div class="howto">
    <h3>How to use:</h3>
    <ol>
      <li>Select the key or shortcut for each button using the dropdowns</li>
      <li>Choose encoder mode: Volume, Zoom or Scroll</li>
      <li>Click "Send to Device" to apply your settings</li>
      <li>Save a preset or download as .txt to share with others</li>
      <li>Import a .txt preset file to instantly load those settings</li>
    </ol>
  </div>
</div>

<script>
let port = null;
let selectedPortIndex = null;
let availablePorts = [];

const DEVICE_NAMES = {
  '2341:0037': 'RageODevice', '2341:8037': 'RageODevice',
  '2341:0237': 'RageODevice', '2341:8237': 'RageODevice',
  '2A03:0037': 'RageODevice', '2A03:8037': 'RageODevice',
  '2342:8038': 'RageODevice',
};

const keys = [
  "Space","Enter","ESC","Backspace","Tab","Delete",
  "W","A","S","D","Q","E","R","F","G","H","J","K","L","Z","X","C","V","B","N","M",
  "Shift","Ctrl","Alt","Win",
  "F1","F2","F3","F4","F5","F6","F7","F8","F9","F10","F11","F12",
  "Up Arrow","Down Arrow","Left Arrow","Right Arrow","Page Up","Page Down","Home","End","Insert",
  "Ctrl+C","Ctrl+V","Ctrl+X","Ctrl+Z","Ctrl+Y","Ctrl+S","Ctrl+A","Ctrl+F","Ctrl+P","Ctrl+N","Ctrl+W","Ctrl+T","Ctrl+Tab","Ctrl+Shift+T",
  "Alt+Tab","Alt+F4","Alt+Enter",
  "Win+D","Win+E","Win+L","Win+R",
  "Task Manager","Print Screen","Mute","Volume Up","Volume Down","Play/Pause","Next Track","Prev Track"
];

const defaults = [0, 2, 72, 0];
let savedPresets = JSON.parse(localStorage.getItem('ragePresets') || '[]');

// ---- PORT PICKER ----

async function openPortDialog() {
  document.getElementById('portOverlay').classList.add('active');
  selectedPortIndex = null;
  document.getElementById('portConnectBtn').disabled = true;
  await refreshPorts();
}

function closePortDialog() {
  document.getElementById('portOverlay').classList.remove('active');
  document.getElementById('connectBtn').disabled = false;
}

async function refreshPorts() {
  const scanning = document.getElementById('portScanning');
  const list = document.getElementById('portList');
  const connectBtn = document.getElementById('portConnectBtn');

  scanning.classList.add('active');
  list.innerHTML = '';
  selectedPortIndex = null;
  connectBtn.disabled = true;

  await new Promise(r => setTimeout(r, 600));

  try {
    availablePorts = await navigator.serial.getPorts();
    scanning.classList.remove('active');

    if(availablePorts.length === 0) {
      list.innerHTML = `
        <div class="port-empty">
          <p>No devices found</p>
          <p>Click "Request Device" to grant access</p>
        </div>
        <div style="text-align:center;margin-top:12px">
          <button class="port-btn-connect" style="margin:0 auto" onclick="requestNewPort()">Request Device</button>
        </div>
      `;
    } else {
      renderPortList();
    }
  } catch(e) {
    scanning.classList.remove('active');
    list.innerHTML = `<div class="port-empty"><p>Error scanning ports</p></div>`;
  }
}

async function refreshPorts() {
  const scanning = document.getElementById('portScanning');
  const list = document.getElementById('portList');
  const connectBtn = document.getElementById('portConnectBtn');

  scanning.classList.add('active');
  list.innerHTML = '';
  selectedPortIndex = null;
  connectBtn.disabled = true;

  await new Promise(r => setTimeout(r, 600));
  scanning.classList.remove('active');

  // Haal eerder toegestane ports op - geen dialoog
  availablePorts = await navigator.serial.getPorts();

  if(availablePorts.length > 0){
    // Auto-selecteer eerste RageODevice
    availablePorts.forEach((p, i) => {
      const info = p.getInfo();
      const vid = info.usbVendorId ? info.usbVendorId.toString(16).toUpperCase().padStart(4,'0') : null;
      const pid = info.usbProductId ? info.usbProductId.toString(16).toUpperCase().padStart(4,'0') : null;
      const key = vid && pid ? `${vid}:${pid}` : null;
      if(key && DEVICE_NAMES[key] && selectedPortIndex === null){
        selectedPortIndex = i;
        connectBtn.disabled = false;
      }
    });
    renderPortList();
  } else {
    // Eerste keer - vraag toegang via requestPort
    list.innerHTML = `
      <div class="port-empty">
        <p>No devices found</p>
        <p style="color:#333;margin-top:4px">Grant access to your RageODevice first</p>
      </div>
      <div style="text-align:center;margin-top:14px">
        <button class="port-btn-connect" onclick="grantAccess()">Grant Access</button>
      </div>
    `;
  }
}

async function grantAccess() {
  try {
    // Dit opent browser dialoog - maar slechts 1 keer ooit nodig
    await navigator.serial.requestPort({
      filters: [
        { usbVendorId: 0x2341, usbProductId: 0x0037 },
        { usbVendorId: 0x2341, usbProductId: 0x8037 },
        { usbVendorId: 0x2341, usbProductId: 0x0237 },
        { usbVendorId: 0x2341, usbProductId: 0x8237 },
        { usbVendorId: 0x2A03, usbProductId: 0x0037 },
        { usbVendorId: 0x2A03, usbProductId: 0x8037 },
        { usbVendorId: 0x2342, usbProductId: 0x8038 },
      ]
    });
    // Daarna altijd via getPorts - nooit meer dialoog
    await refreshPorts();
  } catch(e) {}
}
function renderPortList() {
  const list = document.getElementById('portList');
  if(!availablePorts.length) {
    list.innerHTML = '<div class="port-empty"><p>No devices found</p></div>';
    return;
  }
  list.innerHTML = availablePorts.map((p, i) => {
    const info = p.getInfo();
    const vid = info.usbVendorId ? info.usbVendorId.toString(16).toUpperCase().padStart(4,'0') : null;
    const pid = info.usbProductId ? info.usbProductId.toString(16).toUpperCase().padStart(4,'0') : null;
    const key = vid && pid ? `${vid}:${pid}` : null;
    const deviceName = key && DEVICE_NAMES[key] ? DEVICE_NAMES[key] : 'Unknown Device';
    const isKnown = key && DEVICE_NAMES[key];
    const detail = vid && pid ? `VID: ${vid}  PID: ${pid}` : 'USB Serial Device';
    return `
      <div class="port-item ${i === selectedPortIndex ? 'selected' : ''}" onclick="selectPort(${i})">
        <div class="port-item-left">
          <div class="port-item-name">${deviceName}</div>
          <div class="port-item-detail">${detail}</div>
        </div>
        <div class="port-item-badge ${isKnown ? '' : 'unknown'}">${isKnown ? 'DETECTED' : 'UNKNOWN'}</div>
      </div>
    `;
  }).join('');
}

function selectPort(index) {
  selectedPortIndex = index;
  renderPortList();
  document.getElementById('portConnectBtn').disabled = false;
}

async function connectSelected() {
  if(selectedPortIndex === null || !availablePorts[selectedPortIndex]) return;

  const connectBtn = document.getElementById('portConnectBtn');
  const cancelBtn = document.querySelector('.port-btn-cancel');
  connectBtn.disabled = true;
  connectBtn.textContent = 'Connecting...';
  cancelBtn.style.display = 'none';

  try {
    port = availablePorts[selectedPortIndex];
    await port.open({ baudRate: 115200 });
    closePortDialog();

    setScanState(true, 'Connecting...');
    await new Promise(r => setTimeout(r, 600));
    setScanState(true, 'Established!');
    await new Promise(r => setTimeout(r, 700));
    setScanState(false);

    document.getElementById('page1').classList.remove('active');
    document.getElementById('page2').classList.add('active');
    initSelects();
    showToast('RageODevice Connected');

  } catch(e) {
    connectBtn.disabled = false;
    connectBtn.textContent = 'Connect';
    cancelBtn.style.display = '';
    const errDiv = document.createElement('div');
    errDiv.style.cssText = 'font-size:10px;color:#555;letter-spacing:1px;padding:10px;text-align:center;';
    errDiv.textContent = 'Failed: ' + e.message;
    document.getElementById('portList').appendChild(errDiv);
  }
}

// ---- SELECTS ----

function buildOptions(selectId, defaultVal) {
  const sel = document.getElementById(selectId);
  sel.innerHTML = '';
  keys.forEach((k, i) => {
    const opt = document.createElement('option');
    opt.value = i;
    opt.textContent = k;
    if(i === defaultVal) opt.selected = true;
    sel.appendChild(opt);
  });
}

function initSelects() {
  buildOptions('b1', defaults[0]);
  buildOptions('b2', defaults[1]);
  buildOptions('b3', defaults[2]);
  buildOptions('b4', defaults[3]);
  renderPresetList();
}

function updateEncoderDisplay() {
  const mode = document.getElementById('enc').value;
  const disp = document.getElementById('encoderDisplay');
  if(mode == 0) disp.textContent = 'VOL';
  else if(mode == 1) disp.textContent = 'ZOOM';
  else disp.textContent = 'SCR';
}

function getCurrentConfig() {
  return {
    b1: parseInt(document.getElementById('b1').value),
    b2: parseInt(document.getElementById('b2').value),
    b3: parseInt(document.getElementById('b3').value),
    b4: parseInt(document.getElementById('b4').value),
    enc: parseInt(document.getElementById('enc').value)
  };
}

function applyConfig(cfg) {
  document.getElementById('b1').value = cfg.b1;
  document.getElementById('b2').value = cfg.b2;
  document.getElementById('b3').value = cfg.b3;
  document.getElementById('b4').value = cfg.b4;
  document.getElementById('enc').value = cfg.enc ?? 0;
  updateEncoderDisplay();
}

// ---- SEND TO DEVICE ----

async function sendToDevice() {
  if(!port) { showToast('Not connected!'); return; }

  const sendBtn = document.getElementById('sendBtn');
  const progressEl = document.getElementById('flashProgress');
  const fillEl = document.getElementById('progressFill');
  const textEl = document.getElementById('progressText');

  try {
    sendBtn.disabled = true;
    progressEl.classList.add('active');
    fillEl.style.width = '0%';
    textEl.textContent = 'Preparing...';
    await new Promise(r => setTimeout(r, 300));

    fillEl.style.width = '20%';
    textEl.textContent = 'Sending settings...';

    const cfg = getCurrentConfig();
    const jsonStr = JSON.stringify(cfg) + '\n';
    console.log('Sending:', jsonStr);

    const encoded = new TextEncoder().encode(jsonStr);
    const writer = port.writable.getWriter();

    // Stuur byte voor byte met kleine pauze voor betrouwbaarheid
    for(let i = 0; i < encoded.length; i++){
      await writer.write(encoded.slice(i, i + 1));
      await new Promise(r => setTimeout(r, 8));
      fillEl.style.width = (20 + (i / encoded.length) * 50) + '%';
    }

    writer.releaseLock();

    fillEl.style.width = '80%';
    textEl.textContent = 'Writing to EEPROM...';
    await new Promise(r => setTimeout(r, 1000));

    fillEl.style.width = '100%';
    textEl.textContent = 'Done!';

    const statusEl = document.getElementById('status');
    statusEl.textContent = 'Settings Applied!';
    statusEl.classList.add('success');
    setTimeout(() => { statusEl.textContent = 'Connected'; statusEl.classList.remove('success'); }, 2000);

    showToast('Settings Saved to Device');
    await new Promise(r => setTimeout(r, 800));
    progressEl.classList.remove('active');
    fillEl.style.width = '0%';
    sendBtn.disabled = false;

  } catch(e) {
    progressEl.classList.remove('active');
    sendBtn.disabled = false;
    document.getElementById('status').textContent = 'Error: ' + e.message;
    showToast('Failed: ' + e.message);
    console.error(e);
  }
}

// ---- PRESETS ----

function configToText(name, cfg) {
  return [
    '# RageODevice Preset',
    '# NAME: ' + name,
    '# DATE: ' + new Date().toLocaleString(),
    '',
    'S1=' + cfg.b1 + '  # ' + keys[cfg.b1],
    'S2=' + cfg.b2 + '  # ' + keys[cfg.b2],
    'S3=' + cfg.b3 + '  # ' + keys[cfg.b3],
    'S4=' + cfg.b4 + '  # ' + keys[cfg.b4],
    'ENC=' + (cfg.enc??0) + '  # ' + ['Volume','Zoom','Scroll'][cfg.enc??0],
  ].join('\n');
}

function textToConfig(text) {
  const cfg = {};
  for(const line of text.split('\n')) {
    const clean = line.split('#')[0].trim();
    if(!clean) continue;
    const [key, val] = clean.split('=');
    if(!key || val === undefined) continue;
    const num = parseInt(val.trim());
    if(key.trim() === 'S1') cfg.b1 = num;
    else if(key.trim() === 'S2') cfg.b2 = num;
    else if(key.trim() === 'S3') cfg.b3 = num;
    else if(key.trim() === 'S4') cfg.b4 = num;
    else if(key.trim() === 'ENC') cfg.enc = num;
  }
  return cfg;
}

function getNameFromText(text, fallback) {
  const line = text.split('\n').find(l => l.startsWith('# NAME:'));
  return line ? line.replace('# NAME:','').trim() : fallback;
}

function savePreset() {
  const name = document.getElementById('presetNameInput').value.trim();
  if(!name) { showToast('Enter a preset name!'); return; }
  const preset = { name, date: new Date().toLocaleDateString(), config: getCurrentConfig() };
  const idx = savedPresets.findIndex(p => p.name === name);
  if(idx >= 0) { savedPresets[idx] = preset; showToast('Preset updated'); }
  else { savedPresets.push(preset); showToast('Preset saved'); }
  localStorage.setItem('ragePresets', JSON.stringify(savedPresets));
  document.getElementById('presetNameInput').value = '';
  renderPresetList();
}

function downloadPreset() {
  const name = document.getElementById('presetNameInput').value.trim() || 'MyPreset';
  triggerDownload(name, configToText(name, getCurrentConfig()));
  showToast('Downloaded: ' + name + '.txt');
}

function importPreset(event) {
  const file = event.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const text = e.target.result;
      const cfg = textToConfig(text);
      if(cfg.b1 === undefined) { showToast('Invalid preset file!'); return; }
      applyConfig(cfg);
      const name = getNameFromText(text, file.name.replace('.txt',''));
      const preset = { name, date: new Date().toLocaleDateString(), config: cfg };
      const idx = savedPresets.findIndex(p => p.name === name);
      if(idx >= 0) savedPresets[idx] = preset;
      else savedPresets.push(preset);
      localStorage.setItem('ragePresets', JSON.stringify(savedPresets));
      renderPresetList();
      showToast('Loaded: ' + name);
    } catch(err) { showToast('Failed to load preset!'); }
  };
  reader.readAsText(file);
  event.target.value = '';
}

function loadPreset(i) {
  const p = savedPresets[i];
  if(!p) return;
  applyConfig(p.config);
  document.getElementById('presetNameInput').value = p.name;
  showToast('Loaded: ' + p.name);
}

function downloadSaved(i) {
  const p = savedPresets[i];
  if(!p) return;
  triggerDownload(p.name, configToText(p.name, p.config));
  showToast('Downloaded: ' + p.name + '.txt');
}

function deletePreset(i) {
  const name = savedPresets[i].name;
  savedPresets.splice(i, 1);
  localStorage.setItem('ragePresets', JSON.stringify(savedPresets));
  renderPresetList();
  showToast('Deleted: ' + name);
}

function triggerDownload(name, text) {
  const blob = new Blob([text], {type:'text/plain'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = name.replace(/\s+/g,'_') + '.txt';
  a.click(); URL.revokeObjectURL(url);
}

function renderPresetList() {
  const list = document.getElementById('presetList');
  if(!savedPresets.length) {
    list.innerHTML = '<div class="preset-empty">No saved presets yet</div>';
    return;
  }
  list.innerHTML = savedPresets.map((p,i) => `
    <div class="preset-item">
      <span class="preset-item-name">${p.name}</span>
      <span class="preset-item-date">${p.date}</span>
      <div class="preset-item-actions">
        <button class="preset-action-btn load" onclick="loadPreset(${i})">Load</button>
        <button class="preset-action-btn dl" onclick="downloadSaved(${i})">Download</button>
        <button class="preset-action-btn del" onclick="deletePreset(${i})">Delete</button>
      </div>
    </div>
  `).join('');
}

// ---- UTILS ----

function showToast(msg, duration=2500) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), duration);
}

function setScanState(active, text='') {
  document.getElementById('scanCircle').classList.toggle('active', active);
  document.getElementById('scanDots').classList.toggle('active', active);
  document.getElementById('scanText').textContent = text;
}

async function disconnectDevice() {
  if(port) {
    try { await port.close(); } catch(e) {}
    port = null;
  }
  document.getElementById('page2').classList.remove('active');
  document.getElementById('page1').classList.add('active');
  document.getElementById('connectBtn').disabled = false;
  setScanState(false);
  showToast('Disconnected');
}

document.getElementById('portOverlay').addEventListener('click', function(e) {
  if(e.target === this) closePortDialog();
});
</script>
</body>
</html>
