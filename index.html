<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>RageODevice</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{background:#000;color:#fff;font-family:Orbitron,sans-serif;text-align:center;min-height:100vh;padding:16px}
.page{display:none}.page.active{display:block}
h1{margin:24px 0 6px;font-size:clamp(28px,6vw,42px);font-weight:900;letter-spacing:4px}
.subtitle{color:#555;font-size:10px;margin-bottom:24px;letter-spacing:4px;text-transform:uppercase}
.connection-box{background:#0c0c0c;border:2px solid #2a2a2a;border-radius:20px;padding:clamp(28px,6vw,50px);max-width:520px;margin:0 auto}
.connect-btn{background:#fff;color:#000;border:none;padding:16px 40px;border-radius:999px;font-weight:900;cursor:pointer;font-family:Orbitron,sans-serif;font-size:12px;letter-spacing:2px;min-height:48px}
.connect-btn:disabled{background:#1a1a1a;color:#444}
.board{width:min(650px,100%);height:min(420px,72vw);margin:0 auto 20px;border:2px solid #2a2a2a;border-radius:20px;position:relative;background:#0c0c0c}
.oled{position:absolute;top:7%;left:50%;transform:translateX(-50%);width:min(210px,38%);height:min(110px,22%);border:2px solid #2a2a2a;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:clamp(12px,2.5vw,16px);font-weight:700;background:#000}
.buttons{position:absolute;bottom:8%;left:50%;transform:translateX(-50%);display:flex;gap:min(18px,3vw);max-width:95%}
.encoder{width:min(110px,22vw);height:min(110px,22vw);border:2px solid #2a2a2a;border-radius:50%;display:flex;align-items:center;justify-content:center;background:#000;font-weight:700;font-size:10px;cursor:pointer}
.btn{width:min(130px,26vw);height:min(130px,26vw);min-width:72px;min-height:72px;border:2px solid #2a2a2a;border-radius:14px;display:flex;align-items:center;justify-content:center;background:#000;font-size:clamp(14px,3vw,18px);font-weight:900;cursor:pointer}
.config-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.94);z-index:2000;display:none;align-items:center;justify-content:center;padding:16px;overflow-y:auto}
.config-overlay.active{display:flex}
.config-panel{background:#0c0c0c;border:2px solid #2a2a2a;border-radius:20px;padding:24px 20px;width:100%;max-width:420px;max-height:90vh;overflow-y:auto}
.config-tabs{display:flex;gap:8px;margin-bottom:20px}
.config-tab{flex:1;background:transparent;color:#555;border:2px solid #222;padding:12px 8px;border-radius:10px;font-family:Orbitron,sans-serif;font-size:11px;cursor:pointer;font-weight:700;min-height:44px}
.config-tab.active{background:#fff;color:#000}
.config-section{display:none}.config-section.active{display:block}
.config-select,.config-input{background:#000;color:#fff;border:2px solid #fff;padding:12px;font-family:Orbitron,sans-serif;width:100%;border-radius:10px;font-size:12px;margin-bottom:15px;min-height:48px}
.config-btns{display:flex;gap:10px;margin-top:25px}
.config-btn-cancel,.config-btn-save{flex:1;padding:14px;border-radius:10px;font-family:Orbitron,sans-serif;font-size:12px;cursor:pointer;font-weight:700}
.config-btn-cancel{background:transparent;color:#555;border:2px solid #222}
.config-btn-save{background:#fff;color:#000;border:none;font-weight:900}
.flash-btn{background:#fff;color:#000;border:none;padding:15px 45px;border-radius:30px;font-weight:900;cursor:pointer;font-family:Orbitron,sans-serif;font-size:13px}
.flash-btn:disabled{background:#1a1a1a;color:#444}
.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(100px);background:#fff;color:#000;padding:14px 24px;border-radius:999px;font-size:12px;font-weight:700;z-index:9999;transition:transform .35s}
.toast.show{transform:translateX(-50%) translateY(0)}
.port-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.92);z-index:1000;display:none;align-items:center;justify-content:center;padding:16px}
.port-overlay.active{display:flex}
.port-dialog{background:#0c0c0c;border:2px solid #2a2a2a;border-radius:20px;padding:28px 24px;width:100%;max-width:440px;max-height:85vh;overflow:hidden;display:flex;flex-direction:column}
.port-list{display:flex;flex-direction:column;gap:8px;max-height:240px;overflow-y:auto;margin-bottom:16px}
.port-item{display:flex;align-items:center;justify-content:space-between;background:#000;border:1px solid #1a1a1a;border-radius:10px;padding:14px 16px;cursor:pointer;min-height:56px}
.port-item.selected{border-color:#fff;background:#111}
.port-btn-connect{background:#fff;color:#000;border:none;padding:12px 20px;border-radius:10px;font-family:Orbitron,sans-serif;font-size:11px;font-weight:900;cursor:pointer;min-height:44px}
.port-btn-connect:disabled{background:#1a1a1a;color:#444}
.mobile-warning{display:none;margin-top:12px;padding:12px;background:rgba(255,200,0,0.08);border:1px solid rgba(255,200,0,0.3);border-radius:10px;font-size:11px;color:#ccc;line-height:1.6;text-align:left}
.mobile-warning.show{display:block}
@media(max-width:600px){
  .encoder{width:min(90px,20vw);height:min(90px,20vw)}
  .btn{width:min(100px,22vw);height:min(100px,22vw);min-width:64px;min-height:64px}
}
</style>
</head>
<body>

<div class="toast" id="toast"></div>

<div class="port-overlay" id="portOverlay">
  <div class="port-dialog">
    <h3 style="font-size:16px;margin-bottom:8px">Select Device</h3>
    <p style="color:#555;font-size:10px;margin-bottom:20px">Choose your RageODevice</p>
    <div class="port-list" id="portList"></div>
    <div style="display:flex;gap:10px;margin-top:8px">
      <button style="flex:1;background:transparent;color:#555;border:1px solid#222;padding:12px;border-radius:10px;font-family:Orbitron;font-size:11px;cursor:pointer" onclick="closePortDialog()">Cancel</button>
      <button class="port-btn-connect" id="portConnectBtn" onclick="connectSelected()" disabled>Connect</button>
    </div>
    <div class="mobile-warning" id="mobileWarning">
      <strong>ðŸ“± Mobile Tips:</strong><br>
      â€¢ Use Chrome on Android<br>
      â€¢ Connect RageODevice with USB OTG cable<br>
      â€¢ Device must be powered on<br>
      â€¢ iOS/Safari NOT supported - use computer or Android
    </div>
  </div>
</div>

<div class="config-overlay" id="configOverlay">
  <div class="config-panel">
    <h3 id="configTitle" style="font-size:16px;margin-bottom:20px;text-align:center">Configure S1</h3>
    <div class="config-tabs">
      <button class="config-tab active" onclick="switchTab('key')">Key</button>
      <button class="config-tab" onclick="switchTab('text')">Text</button>
      <button class="config-tab" onclick="switchTab('password')">Password</button>
      <button class="config-tab" onclick="switchTab('script')">Script</button>
    </div>
    <div>
      <div class="config-section active" id="tab-key">
        <label style="font-size:10px;color:#555;margin-bottom:8px;display:block">SELECT KEY</label>
        <select class="config-select" id="tempKey"></select>
      </div>
      <div class="config-section" id="tab-text">
        <label style="font-size:10px;color:#555;margin-bottom:8px;display:block">TEXT TO TYPE</label>
        <input type="text" class="config-input" id="tempText" placeholder="Enter text (max 50 chars)" maxlength="50">
      </div>
      <div class="config-section" id="tab-password">
        <label style="font-size:10px;color:#555;margin-bottom:8px;display:block">PASSWORD</label>
        <input type="password" class="config-input" id="tempPassword" placeholder="Enter password (max 50 chars)" maxlength="50">
      </div>
      <div class="config-section" id="tab-script">
        <label style="font-size:10px;color:#555;margin-bottom:8px;display:block">CUSTOM SHORTCUT</label>
        <input type="text" class="config-input" id="tempScript" placeholder="e.g., Alt+Tab, Win+Shift+S (max 50 chars)" maxlength="50">
      </div>
    </div>
    <div class="config-btns">
      <button class="config-btn-cancel" onclick="closeConfig()">Cancel</button>
      <button class="config-btn-save" onclick="saveConfig()">Save</button>
    </div>
  </div>
</div>

<div id="page1" class="page active">
  <h1>RageODevice</h1>
  <p class="subtitle">CUSTOM KEYBOARD CONFIGURATOR</p>
  <div style="display:flex;align-items:center;justify-content:center;min-height:60vh">
    <div class="connection-box">
      <h2 style="font-size:18px;margin-bottom:8px">Connect</h2>
      <p style="color:#555;font-size:11px;margin-bottom:20px">Connect via USB</p>
      <button class="connect-btn" onclick="openPortDialog()">Connect Device</button>
    </div>
  </div>
</div>

<div id="page2" class="page">
  <h1>RageODevice</h1>
  <p class="subtitle">CONFIGURATOR</p>
  <div class="board">
    <div class="oled">RageODevice</div>
    <div class="buttons">
      <div style="display:flex;flex-direction:column;gap:8px">
        <div class="encoder" onclick="openConfig('enc')">
          <div style="text-align:center">
            <div style="font-size:14px;font-weight:900" id="encDisplay">VOL</div>
            <div style="font-size:7px;color:#555;margin-top:4px">Encoder</div>
          </div>
        </div>
        <div class="btn" onclick="openConfig('b1')">S1</div>
      </div>
      <div class="btn" onclick="openConfig('b2')">S2</div>
      <div class="btn" onclick="openConfig('b3')">S3</div>
      <div class="btn" onclick="openConfig('b4')">S4</div>
    </div>
  </div>
  <div style="margin-top:35px;display:flex;justify-content:center;gap:15px">
    <button class="flash-btn" onclick="sendToDevice()">Send to Device</button>
  </div>
</div>

<script>
let port=null,selectedPortIndex=null,availablePorts=[],currentConfig='b1',currentTab='key';
const DEVICE_NAMES={'2341:0037':'RageODevice','2341:8037':'RageODevice','2341:0237':'RageODevice','2341:8237':'RageODevice','2A03:0037':'RageODevice','2A03:8037':'RageODevice','2342:8038':'RageODevice'};
const keys=["Space","Enter","ESC","Backspace","Tab","Delete","W","A","S","D","Q","E","R","F","G","H","J","K","L","Z","X","C","V","B","N","M","Shift","Ctrl","Alt","Win","F1","F2","F3","F4","F5","F6","F7","F8","F9","F10","F11","F12","Up Arrow","Down Arrow","Left Arrow","Right Arrow","Page Up","Page Down","Home","End","Insert","Ctrl+C","Ctrl+V","Ctrl+X","Ctrl+Z","Ctrl+Y","Ctrl+S","Ctrl+A","Ctrl+F","Ctrl+P","Ctrl+N","Ctrl+W","Ctrl+T","Ctrl+Tab","Ctrl+Shift+T","Alt+Tab","Alt+F4","Alt+Enter","Win+D","Win+E","Win+L","Win+R","Task Manager","Print Screen","Mute","Volume Up","Volume Down","Play/Pause","Next Track","Prev Track"];
let config={b1:{mode:'key',key:0,text:''},b2:{mode:'key',key:2,text:''},b3:{mode:'key',key:72,text:''},b4:{mode:'key',key:0,text:''},enc:{mode:0,text:''}};

function isMobile(){return/Android|iPhone|iPad/i.test(navigator.userAgent)}
function isSerialSupported(){return typeof navigator!=='undefined'&&navigator.serial!=null}

async function openPortDialog(){
  if(!isSerialSupported()){showToast('USB not supported');return}
  document.getElementById('portOverlay').classList.add('active');
  if(isMobile())document.getElementById('mobileWarning').classList.add('show');
  selectedPortIndex=null;
  document.getElementById('portConnectBtn').disabled=true;
  await refreshPorts();
}

function closePortDialog(){document.getElementById('portOverlay').classList.remove('active')}

async function refreshPorts(){
  if(!isSerialSupported())return;
  const list=document.getElementById('portList');
  list.innerHTML='<div style="text-align:center;padding:20px;color:#555;font-size:10px">Scanning...</div>';
  await new Promise(r=>setTimeout(r,600));
  availablePorts=await navigator.serial.getPorts();
  
  if(availablePorts.length>0){
    availablePorts.forEach((p,i)=>{
      const info=p.getInfo();
      const vid=info.usbVendorId?info.usbVendorId.toString(16).toUpperCase().padStart(4,'0'):null;
      const pid=info.usbProductId?info.usbProductId.toString(16).toUpperCase().padStart(4,'0'):null;
      const key=vid&&pid?`${vid}:${pid}`:null;
      if(key&&DEVICE_NAMES[key]&&selectedPortIndex===null){
        selectedPortIndex=i;
        document.getElementById('portConnectBtn').disabled=false;
      }
    });
    renderPortList();
  }else{
    list.innerHTML='<div style="text-align:center;padding:20px"><p style="color:#555;font-size:10px;margin-bottom:12px">No devices found</p><button class="port-btn-connect" onclick="grantAccess()">Grant Access</button></div>';
  }
}

async function grantAccess(){
  try{
    let newPort=null;
    try{
      // Try with filters first (works best on desktop)
      newPort=await navigator.serial.requestPort({
        filters:[
          {usbVendorId:0x2341,usbProductId:0x0037},
          {usbVendorId:0x2341,usbProductId:0x8037},
          {usbVendorId:0x2341,usbProductId:0x0237},
          {usbVendorId:0x2341,usbProductId:0x8237},
          {usbVendorId:0x2A03,usbProductId:0x0037},
          {usbVendorId:0x2A03,usbProductId:0x8037},
          {usbVendorId:0x2342,usbProductId:0x8038}
        ]
      });
    }catch(filterErr){
      // On mobile Chrome/Android, filters sometimes block device from showing
      // Try without filters to show ALL USB serial devices
      console.log('Trying without filters for mobile...');
      newPort=await navigator.serial.requestPort();
    }
    if(newPort){
      await refreshPorts();
      showToast('Device access granted!');
    }
  }catch(e){
    console.error('Grant access error:',e);
    if(e.name==='NotFoundError'){
      showToast('No device selected');
    }else if(e.name==='NotSupportedError'){
      showToast('USB not supported on this device');
    }else{
      showToast('Error: '+e.message);
    }
  }
}

function renderPortList(){
  const list=document.getElementById('portList');
  if(!availablePorts.length){list.innerHTML='<div style="text-align:center;padding:20px;color:#555">No devices</div>';return}
  list.innerHTML=availablePorts.map((p,i)=>{
    const info=p.getInfo();
    const vid=info.usbVendorId?info.usbVendorId.toString(16).toUpperCase().padStart(4,'0'):null;
    const pid=info.usbProductId?info.usbProductId.toString(16).toUpperCase().padStart(4,'0'):null;
    const key=vid&&pid?`${vid}:${pid}`:null;
    const deviceName=key&&DEVICE_NAMES[key]?DEVICE_NAMES[key]:'USB Device';
    const detail=vid&&pid?`${vid}:${pid}`:'Serial Port';
    return `<div class="port-item ${i===selectedPortIndex?'selected':''}" onclick="selectPort(${i})"><div style="flex:1"><div style="font-size:13px;font-weight:700;margin-bottom:2px">${deviceName}</div><div style="font-size:9px;color:#555">${detail}</div></div></div>`;
  }).join('');
}

function selectPort(index){selectedPortIndex=index;renderPortList();document.getElementById('portConnectBtn').disabled=false}

async function connectSelected(){
  if(selectedPortIndex===null||!availablePorts[selectedPortIndex])return;
  try{
    port=availablePorts[selectedPortIndex];
    await port.open({baudRate:115200});
    closePortDialog();
    document.getElementById('page1').classList.remove('active');
    document.getElementById('page2').classList.add('active');
    initControls();
    showToast('Connected!');
  }catch(e){
    showToast('Connection failed: '+e.message);
  }
}

function initControls(){
  updateEncDisplay();
  const sel=document.getElementById('tempKey');
  sel.innerHTML='';
  keys.forEach((k,i)=>{
    const opt=document.createElement('option');
    opt.value=i;opt.textContent=k;
    sel.appendChild(opt);
  });
}

function openConfig(target){
  currentConfig=target;
  const titles={enc:'Encoder',b1:'S1',b2:'S2',b3:'S3',b4:'S4'};
  document.getElementById('configTitle').textContent='Configure '+(titles[target]||target.toUpperCase());
  
  if(target==='enc'){
    const sel=document.getElementById('tempKey');
    sel.innerHTML='';
    ['Volume','Zoom','Scroll'].forEach((label,i)=>{
      const opt=document.createElement('option');
      opt.value=i;opt.textContent=label;
      sel.appendChild(opt);
    });
    currentTab=config.enc.text?'text':'key';
    document.getElementById('tempKey').value=config.enc.mode;
    document.getElementById('tempText').value=config.enc.text;
    document.getElementById('tempPassword').value=config.enc.text;
    document.getElementById('tempScript').value=config.enc.text;
  }else{
    initControls();
    currentTab=config[target].mode;
    document.getElementById('tempKey').value=config[target].key;
    document.getElementById('tempText').value=config[target].text;
    document.getElementById('tempPassword').value=config[target].text;
    document.getElementById('tempScript').value=config[target].text;
  }
  
  switchTab(currentTab);
  document.getElementById('configOverlay').classList.add('active');
}

function closeConfig(){document.getElementById('configOverlay').classList.remove('active')}

function switchTab(tab){
  currentTab=tab;
  document.querySelectorAll('.config-tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.config-section').forEach(s=>s.classList.remove('active'));
  const tabIndex=['key','text','password','script'].indexOf(tab);
  document.querySelectorAll('.config-tab')[tabIndex].classList.add('active');
  document.getElementById('tab-'+tab).classList.add('active');
}

function saveConfig(){
  if(currentConfig==='enc'){
    if(currentTab==='key'){
      config.enc.mode=parseInt(document.getElementById('tempKey').value);
      config.enc.text='';
    }else{
      const val=document.getElementById('temp'+currentTab.charAt(0).toUpperCase()+currentTab.slice(1)).value;
      config.enc.text=val;
    }
    updateEncDisplay();
  }else{
    if(currentTab==='key'){
      config[currentConfig].mode='key';
      config[currentConfig].key=parseInt(document.getElementById('tempKey').value);
      config[currentConfig].text='';
    }else{
      config[currentConfig].mode=currentTab;
      const val=document.getElementById('temp'+currentTab.charAt(0).toUpperCase()+currentTab.slice(1)).value;
      config[currentConfig].text=val;
    }
  }
  closeConfig();
  showToast('Saved');
}

function updateEncDisplay(){
  const modes=['VOL','ZOOM','SCR'];
  document.getElementById('encDisplay').textContent=modes[config.enc.mode];
}

async function sendToDevice(){
  if(!port){showToast('Not connected!');return}
  try{
    const data={
      b1mode:config.b1.mode==='key'?0:1,b1key:config.b1.key,b1text:config.b1.text,
      b2mode:config.b2.mode==='key'?0:1,b2key:config.b2.key,b2text:config.b2.text,
      b3mode:config.b3.mode==='key'?0:1,b3key:config.b3.key,b3text:config.b3.text,
      b4mode:config.b4.mode==='key'?0:1,b4key:config.b4.key,b4text:config.b4.text,
      enc:config.enc.mode,enctext:config.enc.text
    };
    const jsonStr=JSON.stringify(data)+'\n';
    const encoded=new TextEncoder().encode(jsonStr);
    const writer=port.writable.getWriter();
    for(let i=0;i<encoded.length;i++){
      await writer.write(encoded.slice(i,i+1));
      await new Promise(r=>setTimeout(r,8));
    }
    writer.releaseLock();
    await new Promise(r=>setTimeout(r,1000));
    showToast('Sent to device!');
  }catch(e){
    showToast('Failed: '+e.message);
  }
}

function showToast(msg){
  const t=document.getElementById('toast');
  t.textContent=msg;
  t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),2500);
}

document.getElementById('portOverlay').addEventListener('click',e=>{
  if(e.target.id==='portOverlay')closePortDialog();
});
document.getElementById('configOverlay').addEventListener('click',e=>{
  if(e.target.id==='configOverlay')closeConfig();
});
</script>
</body>
</html>
